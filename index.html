<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Niko">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1F476;</text></svg>">
<title>Niko Tracker</title>
<style>
:root {
  --bg: #f5f0eb;
  --card: #ffffff;
  --primary: #6b8f71;
  --primary-dark: #557a5b;
  --sleep: #7ba1c7;
  --feed: #e8a87c;
  --poo: #c4956a;
  --note: #8e8e93;
  --text: #3a3a3a;
  --text-light: #777;
  --border: #e0dbd5;
  --danger: #d9534f;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  padding-bottom: 80px;
}

/* Header */
.header {
  background: var(--primary);
  color: white;
  padding: 14px 20px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  /* sticky already acts as position:relative for child absolute positioning */
}
.header h1 { font-size: 20px; font-weight: 600; letter-spacing: 0.5px; }
.header .date-display { font-size: 13px; opacity: 0.85; margin-top: 2px; }

/* Language toggle */
.lang-toggle {
  position: absolute;
  top: 12px;
  right: 14px;
  display: flex;
  background: rgba(255,255,255,0.2);
  border-radius: 8px;
  overflow: hidden;
  font-size: 12px;
  font-weight: 600;
}
.lang-btn {
  border: none;
  background: transparent;
  color: rgba(255,255,255,0.7);
  padding: 4px 8px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  font-family: inherit;
}
.lang-btn.active {
  background: rgba(255,255,255,0.35);
  color: white;
}

/* Sync indicator */
.sync-bar {
  height: 3px;
  background: transparent;
  position: sticky;
  top: 0;
  z-index: 101;
}
.sync-bar.syncing { background: linear-gradient(90deg, transparent, var(--sleep), transparent); animation: shimmer 1s infinite; }
.sync-bar.error { background: var(--danger); }
@keyframes shimmer { 0%{background-position:-200px 0}100%{background-position:200px 0} }

.sync-status {
  text-align: center;
  font-size: 11px;
  color: var(--text-light);
  padding: 4px;
  cursor: pointer;
}
.sync-status .dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
.sync-status .dot.ok { background: #4caf50; }
.sync-status .dot.err { background: var(--danger); }
.sync-status .dot.loading { background: var(--sleep); animation: pulse 1s infinite; }

/* Quick-add buttons */
.quick-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  padding: 14px 16px;
  max-width: 500px;
  margin: 0 auto;
}
.quick-btn {
  border: none;
  border-radius: 16px;
  padding: 18px 12px;
  font-size: 15px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  box-shadow: var(--shadow);
  transition: transform 0.1s;
  -webkit-user-select: none;
  user-select: none;
}
.quick-btn:active { transform: scale(0.95); }
.quick-btn .icon { font-size: 26px; }
.quick-btn.sleep-btn { background: var(--sleep); }
.quick-btn.feed-btn { background: var(--feed); }
.quick-btn.poo-btn { background: var(--poo); }
.quick-btn.note-btn { background: var(--note); }

/* Time Since Last cards */
.time-since-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  padding: 0 16px 10px;
  max-width: 500px;
  margin: 0 auto;
}
.time-since-card {
  background: var(--card);
  border-radius: 10px;
  padding: 8px 6px;
  text-align: center;
  box-shadow: var(--shadow);
}
.time-since-card .tsl-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  margin-bottom: 2px;
}
.time-since-card .tsl-value {
  font-size: 15px;
  font-weight: 700;
}
.time-since-card .tsl-value.sleep-color { color: var(--sleep); }
.time-since-card .tsl-value.feed-color { color: var(--feed); }
.time-since-card .tsl-value.poo-color { color: var(--poo); }
.time-since-card .tsl-sub {
  font-size: 10px;
  color: var(--text-light);
  margin-top: 1px;
}

/* Modal / Entry Form */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: flex-end;
  justify-content: center;
}
.modal-overlay.active { display: flex; }

.modal {
  background: var(--card);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 500px;
  padding: 20px 20px calc(20px + env(safe-area-inset-bottom, 10px));
  animation: slideUp 0.25s ease-out;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.modal-header h2 { font-size: 18px; }
.modal-close {
  background: none;
  border: none;
  font-size: 28px;
  color: var(--text-light);
  cursor: pointer;
  padding: 4px 8px;
}

.form-group { margin-bottom: 14px; }
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.form-group input, .form-group textarea, .form-group select {
  width: 100%;
  padding: 12px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 16px;
  font-family: inherit;
  background: var(--bg);
  color: var(--text);
  -webkit-appearance: none;
}
.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
  outline: none;
  border-color: var(--primary);
}
.form-group textarea { resize: none; height: 70px; }

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.submit-btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 17px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  margin-top: 6px;
}
.submit-btn:disabled { opacity: 0.6; }
.submit-btn.sleep-btn { background: var(--sleep); }
.submit-btn.feed-btn { background: var(--feed); }
.submit-btn.poo-btn { background: var(--poo); }
.submit-btn.note-btn { background: var(--primary); }

/* Timeline / recent entries */
.section-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 6px 20px 4px;
  max-width: 500px;
  margin: 0 auto;
}

.timeline {
  padding: 0 16px 8px;
  max-width: 500px;
  margin: 0 auto;
}

.entry-card {
  background: var(--card);
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 8px;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: background 0.15s;
}
.entry-card:active { background: var(--bg); }
.entry-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}
.entry-icon.sleep { background: #dce8f3; }
.entry-icon.feed { background: #fae4d3; }
.entry-icon.poo { background: #ecdbc8; }
.entry-icon.note { background: #e5e5e5; }

.entry-details { flex: 1; min-width: 0; }
.entry-details .entry-title { font-weight: 600; font-size: 15px; }
.entry-details .entry-sub { font-size: 13px; color: var(--text-light); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.entry-time { font-size: 13px; color: var(--text-light); white-space: nowrap; }

.entry-delete {
  background: none;
  border: none;
  color: #ccc;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 2px;
}
.entry-delete:active { color: var(--danger); }

.empty-state {
  text-align: center;
  padding: 30px 20px;
  color: var(--text-light);
  font-size: 15px;
}

/* Summary Modal */
.summary-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.summary-overlay.active { display: flex; }

.summary-card {
  background: var(--card);
  border-radius: 16px;
  width: 100%;
  max-width: 440px;
  max-height: 85dvh;
  overflow-y: auto;
  padding: 20px;
  animation: fadeIn 0.2s;
}
@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.summary-tabs {
  display: flex;
  background: var(--bg);
  border-radius: 10px;
  padding: 3px;
  margin-bottom: 16px;
}
.summary-tab {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  background: transparent;
  color: var(--text-light);
  cursor: pointer;
}
.summary-tab.active { background: white; color: var(--text); box-shadow: var(--shadow); }

.summary-stat {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.summary-stat:last-child { border-bottom: none; }
.stat-label { font-size: 14px; color: var(--text-light); display: flex; align-items: center; gap: 8px; }
.stat-value { font-size: 20px; font-weight: 700; }
.stat-value.sleep-color { color: var(--sleep); }
.stat-value.feed-color { color: var(--feed); }
.stat-value.poo-color { color: var(--poo); }

.summary-day-list { margin-top: 12px; }
.summary-day-row {
  display: grid;
  grid-template-columns: 80px 1fr 1fr 1fr;
  gap: 6px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}
.summary-day-row.header { font-weight: 700; color: var(--text-light); text-transform: uppercase; font-size: 11px; }

/* Trends Modal / Overlay */
.trends-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.trends-overlay.active { display: flex; }

.trends-card {
  background: var(--card);
  border-radius: 16px;
  width: 100%;
  max-width: 480px;
  max-height: 90dvh;
  overflow-y: auto;
  padding: 20px;
  animation: fadeIn 0.2s;
}

/* Bar Charts */
.chart-section {
  margin-bottom: 20px;
}
.chart-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}
.chart-container {
  background: var(--bg);
  border-radius: 12px;
  padding: 12px 8px 4px;
}
.chart-area {
  display: flex;
  align-items: flex-end;
  gap: 3px;
  height: 120px;
  padding-bottom: 4px;
  position: relative;
}
.chart-y-label {
  font-size: 10px;
  color: var(--text-light);
  text-align: right;
  margin-bottom: 4px;
}
.chart-bar-wrap {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  justify-content: flex-end;
}
.chart-bar {
  width: 100%;
  max-width: 28px;
  border-radius: 4px 4px 0 0;
  min-height: 0;
  transition: height 0.3s;
  position: relative;
}
.chart-bar.sleep-bar { background: var(--sleep); }
.chart-bar.feed-bar { background: var(--feed); }
.chart-bar-val {
  font-size: 8px;
  font-weight: 700;
  color: var(--text-light);
  text-align: center;
  margin-bottom: 2px;
  white-space: nowrap;
}
.chart-x-labels {
  display: flex;
  gap: 3px;
  margin-top: 4px;
}
.chart-x-label {
  flex: 1;
  text-align: center;
  font-size: 9px;
  color: var(--text-light);
  font-weight: 600;
}

/* Trend key stat cards */
.trend-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 16px;
}
.trend-stat-card {
  background: var(--bg);
  border-radius: 12px;
  padding: 12px 10px;
}
.trend-stat-card .ts-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-light);
  margin-bottom: 4px;
}
.trend-stat-card .ts-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}
.trend-stat-card .ts-sub {
  font-size: 11px;
  color: var(--text-light);
  margin-top: 2px;
}

/* Day vs Night bar */
.day-night-bar-wrap {
  margin-top: 6px;
}
.day-night-bar {
  display: flex;
  height: 14px;
  border-radius: 7px;
  overflow: hidden;
  background: var(--border);
}
.day-night-bar .day-portion {
  background: var(--feed);
  height: 100%;
}
.day-night-bar .night-portion {
  background: var(--sleep);
  height: 100%;
}
.day-night-labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text-light);
  margin-top: 3px;
}

/* Bottom Nav */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--card);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: center;
  gap: 8px;
  padding: 10px 16px;
  padding-bottom: max(10px, env(safe-area-inset-bottom));
  z-index: 100;
}
.nav-btn {
  border: none;
  background: var(--bg);
  border-radius: 10px;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}
.nav-btn:active { background: var(--border); }

/* Date picker row */
.date-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 6px 16px 0;
  max-width: 500px;
  margin: 0 auto;
}
.date-nav button {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 36px;
  height: 36px;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.date-nav button:active { background: var(--border); }
.date-nav input[type="date"] {
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 14px;
  font-family: inherit;
  background: var(--card);
  color: var(--text);
}

/* Sleep tracking active state */
.sleep-active-banner {
  display: none;
  background: var(--sleep);
  color: white;
  text-align: center;
  padding: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  animation: pulse 2s infinite;
}
.sleep-active-banner.active { display: block; }
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

/* Data management */
.data-actions {
  max-width: 500px;
  margin: 12px auto;
  padding: 0 16px;
  display: flex;
  gap: 8px;
}
.data-btn {
  flex: 1;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  color: var(--text-light);
}
.data-btn:active { background: var(--bg); }

/* Toast notification */
.toast {
  position: fixed;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  z-index: 300;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* Fun celebration toast */
.fun-toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: white;
  color: var(--text);
  padding: 24px 32px;
  border-radius: 20px;
  font-size: 22px;
  font-weight: 700;
  z-index: 310;
  opacity: 0;
  transition: opacity 0.3s, transform 0.3s;
  pointer-events: none;
  text-align: center;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}
.fun-toast .fun-icon { font-size: 44px; display: block; margin-bottom: 8px; }
.fun-toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
</style>
</head>
<body>

<div class="header">
  <h1>&#x1F476; <span id="appTitle">Niko Tracker</span></h1>
  <div class="date-display" id="headerDate"></div>
  <div class="lang-toggle">
    <button class="lang-btn active" id="langEn" onclick="setLang('en')">EN</button>
    <button class="lang-btn" id="langJa" onclick="setLang('ja')">JP</button>
  </div>
</div>
<div class="sync-bar" id="syncBar"></div>

<div class="sleep-active-banner" id="sleepBanner" onclick="openSleepWake()">
  &#x1F4A4; Sleeping since <span id="sleepSinceTime"></span> — tap to log wake up
</div>

<!-- Sync status -->
<div class="sync-status" id="syncStatus" onclick="syncFromCloud()">
  <span class="dot ok" id="syncDot"></span> <span id="syncText">Synced</span>
</div>

<!-- Quick-add buttons -->
<div class="quick-actions">
  <button class="quick-btn sleep-btn" onclick="openModal('sleep')">
    <span class="icon">&#x1F4A4;</span>
    <span id="btnSleepLabel">Sleep</span>
  </button>
  <button class="quick-btn feed-btn" onclick="openModal('feed')">
    <span class="icon">&#x1F37C;</span>
    <span id="btnFeedLabel">Feeding</span>
  </button>
  <button class="quick-btn poo-btn" onclick="openModal('poo')">
    <span class="icon">&#x1F4A9;</span>
    <span id="btnPooLabel">Poo</span>
  </button>
  <button class="quick-btn note-btn" onclick="openModal('note')">
    <span class="icon">&#x1F4DD;</span>
    <span id="btnNoteLabel">Note</span>
  </button>
</div>

<!-- Time Since Last display -->
<div class="time-since-row" id="timeSinceRow">
  <div class="time-since-card">
    <div class="tsl-label" id="tslFeedLabel">Last Fed</div>
    <div class="tsl-value feed-color" id="tslFeed">--</div>
    <div class="tsl-sub" id="tslFeedSub"></div>
  </div>
  <div class="time-since-card">
    <div class="tsl-label" id="tslSleepLabel">Last Slept</div>
    <div class="tsl-value sleep-color" id="tslSleep">--</div>
    <div class="tsl-sub" id="tslSleepSub"></div>
  </div>
  <div class="time-since-card">
    <div class="tsl-label" id="tslPooLabel">Last Poo</div>
    <div class="tsl-value poo-color" id="tslPoo">--</div>
    <div class="tsl-sub" id="tslPooSub"></div>
  </div>
</div>

<!-- Date nav for viewing entries -->
<div class="date-nav">
  <button onclick="shiftDate(-1)">&#8592;</button>
  <input type="date" id="viewDate" onchange="renderEntries()">
  <button onclick="shiftDate(1)">&#8594;</button>
</div>

<!-- Recent entries -->
<p class="section-title" style="margin-top:6px">Today's Log</p>
<div class="timeline" id="timeline"></div>

<!-- Data management -->
<div class="data-actions">
  <button class="data-btn" id="exportBtn" onclick="exportData()">&#x1F4E5; Export CSV</button>
</div>

<!-- Bottom nav -->
<div class="bottom-nav">
  <button class="nav-btn" onclick="openSummary('24h')">
    &#x23F0; <span id="navLabel24h">24h</span>
  </button>
  <button class="nav-btn" onclick="openSummary('daily')">
    &#x1F4CA; <span id="navLabelDaily">Daily</span>
  </button>
  <button class="nav-btn" onclick="openSummary('weekly')">
    &#x1F4C5; <span id="navLabelWeekly">Weekly</span>
  </button>
  <button class="nav-btn" onclick="openTrends()">
    &#x1F4C8; <span id="navLabelTrends">Trends</span>
  </button>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>
<div class="fun-toast" id="funToast"><span class="fun-icon" id="funIcon"></span><span id="funMsg"></span></div>

<!-- Entry Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalBg(event)">
  <div class="modal" id="modalContent">
    <div class="modal-header">
      <h2 id="modalTitle">Log Entry</h2>
      <button class="modal-close" onclick="closeModal()">&#215;</button>
    </div>
    <form id="entryForm" onsubmit="saveEntry(event)">
      <input type="hidden" id="entryType">
      <input type="hidden" id="editingId">
      <input type="hidden" id="editingFbKey">

      <!-- Sleep fields -->
      <div id="sleepFields" style="display:none">
        <div class="form-row">
          <div class="form-group">
            <label id="labelFellAsleep">Fell Asleep</label>
            <input type="time" id="sleepStart" step="60">
          </div>
          <div class="form-group">
            <label id="labelWokeUp">Woke Up (optional)</label>
            <input type="time" id="sleepEnd" step="60">
          </div>
        </div>
        <div class="form-group">
          <label id="labelSleepDate">Date</label>
          <input type="date" id="sleepDate">
        </div>
      </div>

      <!-- Feed fields -->
      <div id="feedFields" style="display:none">
        <div class="form-row">
          <div class="form-group">
            <label id="labelFeedTime">Time</label>
            <input type="time" id="feedTime" step="60">
          </div>
          <div class="form-group">
            <label id="labelFeedVolume">Volume (ml)</label>
            <input type="number" id="feedVolume" inputmode="numeric" placeholder="e.g. 90" min="0" step="5">
          </div>
        </div>
        <div class="form-group">
          <label id="labelFeedType">Type</label>
          <select id="feedType">
            <option value="formula" id="optFormula">Formula</option>
            <option value="breast" id="optBreast">Breast Milk</option>
            <option value="mixed" id="optMixed">Mixed</option>
          </select>
        </div>
        <div class="form-group">
          <label id="labelFeedDate">Date</label>
          <input type="date" id="feedDate">
        </div>
      </div>

      <!-- Poo fields -->
      <div id="pooFields" style="display:none">
        <div class="form-row">
          <div class="form-group">
            <label id="labelPooTime">Time</label>
            <input type="time" id="pooTime" step="60">
          </div>
          <div class="form-group">
            <label id="labelPeeToo">Pee too?</label>
            <select id="pooPee">
              <option value="yes" id="optPeeYes">Yes</option>
              <option value="no" id="optPeeNo">No</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label id="labelPooDate">Date</label>
          <input type="date" id="pooDate">
        </div>
        <div class="form-group">
          <label id="labelPooNotes">Notes (optional)</label>
          <input type="text" id="pooNotes" placeholder="Color, consistency...">
        </div>
      </div>

      <!-- Note fields -->
      <div id="noteFields" style="display:none">
        <div class="form-row">
          <div class="form-group">
            <label id="labelNoteTime">Time</label>
            <input type="time" id="noteTime" step="60">
          </div>
          <div class="form-group">
            <label id="labelNoteDate">Date</label>
            <input type="date" id="noteDate">
          </div>
        </div>
        <div class="form-group">
          <label id="labelNote">Note</label>
          <textarea id="noteText" placeholder="Anything to remember..."></textarea>
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">Save</button>
    </form>
  </div>
</div>

<!-- Summary Modal -->
<div class="summary-overlay" id="summaryOverlay" onclick="closeSummaryBg(event)">
  <div class="summary-card">
    <div class="modal-header">
      <h2 id="summaryTitle">Summary</h2>
      <button class="modal-close" onclick="closeSummary()">&#215;</button>
    </div>
    <div class="summary-tabs">
      <button class="summary-tab" id="tab24h" onclick="switchSummaryTab('24h')"><span id="tab24hLabel">24h</span></button>
      <button class="summary-tab active" id="tabDaily" onclick="switchSummaryTab('daily')"><span id="tabDailyLabel">Daily</span></button>
      <button class="summary-tab" id="tabWeekly" onclick="switchSummaryTab('weekly')"><span id="tabWeeklyLabel">Weekly</span></button>
    </div>
    <div id="summaryBody"></div>
  </div>
</div>

<!-- Trends Modal -->
<div class="trends-overlay" id="trendsOverlay" onclick="closeTrendsBg(event)">
  <div class="trends-card">
    <div class="modal-header">
      <h2 id="trendsTitle">&#x1F4C8; Trends (14 Days)</h2>
      <button class="modal-close" onclick="closeTrends()">&#215;</button>
    </div>
    <div id="trendsBody"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════
// FIREBASE CONFIG — This is your shared cloud database
// ═══════════════════════════════════════════════════════
const FIREBASE_URL = 'https://niko-tracker-default-rtdb.firebaseio.com';
const SECRET_PATH  = 'nk_v2r9x7m4q1';  // acts as a private key for your data
const DB = FIREBASE_URL + '/' + SECRET_PATH;

// ═══════════════════════════════════════════════════════
// DATA LAYER — Firebase REST API + local cache
// ═══════════════════════════════════════════════════════
let entriesCache = [];     // local in-memory cache
let isSyncing = false;

// --- Read all entries from Firebase ---
async function syncFromCloud() {
  setSyncStatus('loading', t('syncing'));
  try {
    const res = await fetch(DB + '/entries.json');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data) {
      entriesCache = Object.entries(data).map(([fbKey, val]) => {
        val._fbKey = fbKey;
        return val;
      });
    } else {
      entriesCache = [];
    }
    // Also sync sleep state
    const sleepRes = await fetch(DB + '/sleepActive.json');
    const sleepData = await sleepRes.json();
    if (sleepData) {
      localStorage.setItem('niko_sleep_active', JSON.stringify(sleepData));
    } else {
      localStorage.removeItem('niko_sleep_active');
    }
    setSyncStatus('ok', t('syncedJustNow'));
    renderEntries();
    renderTimeSinceLast();
    checkSleepActive();
  } catch (err) {
    console.error('Sync failed:', err);
    setSyncStatus('error', t('syncFailed'));
  }
}

// --- Add a single entry to Firebase ---
async function addEntry(entry) {
  entry.id = Date.now() + '_' + Math.random().toString(36).slice(2, 7);
  entry.createdAt = new Date().toISOString();

  // Optimistic: add to local cache immediately
  entriesCache.push(entry);
  renderEntries();
  renderTimeSinceLast();

  try {
    const res = await fetch(DB + '/entries.json', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(entry)
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const result = await res.json();
    // Store the Firebase key
    entry._fbKey = result.name;
    showToast(t('savedCheck'));
    setSyncStatus('ok', t('syncedJustNow'));
  } catch (err) {
    console.error('Save failed:', err);
    showToast(t('saveFailedToast'));
    setSyncStatus('error', t('saveFailed'));
  }
}

// --- Delete an entry from Firebase ---
async function deleteEntry(id) {
  const entry = entriesCache.find(e => e.id === id);
  if (!entry) return;

  // Optimistic: remove from local cache
  entriesCache = entriesCache.filter(e => e.id !== id);
  renderEntries();
  renderTimeSinceLast();

  if (entry._fbKey) {
    try {
      await fetch(DB + '/entries/' + entry._fbKey + '.json', { method: 'DELETE' });
      showToast(t('deleted'));
      setSyncStatus('ok', t('syncedJustNow'));
    } catch (err) {
      console.error('Delete failed:', err);
      setSyncStatus('error', t('deleteFailed'));
    }
  }
}

// --- Update an existing entry in Firebase ---
async function updateEntry(id, fbKey, updatedData) {
  // Optimistic: update local cache
  const idx = entriesCache.findIndex(e => e.id === id);
  if (idx !== -1) {
    Object.assign(entriesCache[idx], updatedData);
    renderEntries();
    renderTimeSinceLast();
  }

  if (fbKey) {
    try {
      await fetch(DB + '/entries/' + fbKey + '.json', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      });
      showToast(t('updatedCheck'));
      setSyncStatus('ok', t('syncedJustNow'));
    } catch (err) {
      console.error('Update failed:', err);
      showToast(t('updateFailedToast'));
      setSyncStatus('error', t('updateFailed'));
    }
  }
}

// --- Save / clear sleep active state to Firebase ---
async function saveSleepActive(data) {
  if (data) {
    localStorage.setItem('niko_sleep_active', JSON.stringify(data));
    try { await fetch(DB + '/sleepActive.json', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }); } catch(e) {}
  } else {
    localStorage.removeItem('niko_sleep_active');
    try { await fetch(DB + '/sleepActive.json', { method: 'DELETE' }); } catch(e) {}
  }
}

function loadEntries() { return entriesCache; }

// ═══════════════════════════════════════════════════════
// UI HELPERS
// ═══════════════════════════════════════════════════════
function todayStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function nowTimeStr() {
  const d = new Date();
  return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
}
function formatTime12(t) {
  if (!t) return '';
  const [h, m] = t.split(':').map(Number);
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12 = h % 12 || 12;
  return h12 + ':' + String(m).padStart(2,'0') + ' ' + ampm;
}
function formatDateShort(d) {
  const dt = new Date(d + 'T00:00:00');
  const locale = currentLang === 'ja' ? 'ja-JP' : 'en-US';
  return dt.toLocaleDateString(locale, { weekday: 'short', month: 'short', day: 'numeric' });
}
function getWeekStart(dateStr) {
  const d = new Date(dateStr + 'T00:00:00');
  const day = d.getDay();
  d.setDate(d.getDate() - day);
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function addDays(dateStr, n) {
  const d = new Date(dateStr + 'T00:00:00');
  d.setDate(d.getDate() + n);
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function dateStrFromDate(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function setSyncStatus(state, text) {
  const dot = document.getElementById('syncDot');
  const txt = document.getElementById('syncText');
  const bar = document.getElementById('syncBar');
  dot.className = 'dot ' + (state === 'ok' ? 'ok' : state === 'error' ? 'err' : 'loading');
  txt.textContent = text;
  bar.className = 'sync-bar' + (state === 'loading' ? ' syncing' : state === 'error' ? ' error' : '');
}

let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.innerHTML = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 1500);
}

let funToastTimer;
const funToasts = {
  feed: [
    '\u3054\u3061\u305D\u3046\u3055\u307E\u3067\u3057\u305F\uFF01',
    '\u304A\u306A\u304B\u3044\u3063\u3071\u3044\uFF01',
    '\u3082\u3050\u3082\u3050\u30BF\u30A4\u30E0\u7D42\u4E86\uFF01',
    '\u30DF\u30EB\u30AF\u6700\u9AD8\uFF01',
    '\u3088\u304F\u98F2\u307F\u307E\u3057\u305F\uFF01'
  ],
  poo: [
    '\u304A\u75B2\u308C\u3055\u307E\u3067\u3057\u305F\uFF01',
    '\u3046\u3093\u3061\u5927\u6210\u529F\uFF01',
    '\u30B9\u30C3\u30AD\u30EA\u3057\u305F\u306D\uFF01',
    '\u304A\u306A\u304B\u8EFD\u304F\u306A\u3063\u305F\u306D\uFF01',
    '\u4ECA\u65E5\u3082\u3088\u304F\u51FA\u307E\u3057\u305F\uFF01'
  ],
  sleepStart: [
    '\u304A\u3084\u3059\u307F\u306A\u3055\u3044\uFF01',
    '\u3044\u3044\u5922\u898B\u3066\u306D\uFF01',
    '\u3059\u3084\u3059\u3084\u30BF\u30A4\u30E0\uFF01',
    '\u304A\u3084\u3059\u307F\u3001\u30CB\u30B3\u3061\u3083\u3093\uFF01',
    '\u5922\u306E\u4E16\u754C\u3078\u51FA\u767A\uFF01'
  ],
  sleepEnd: [
    '\u304A\u306F\u3088\u3046\u3054\u3056\u3044\u307E\u3059\uFF01',
    '\u304A\u306F\u3088\u3046\u3001\u30CB\u30B3\u3061\u3083\u3093\uFF01',
    '\u3088\u304F\u5BDD\u305F\u306D\uFF01',
    '\u5143\u6C17\u306B\u8D77\u304D\u305F\uFF01',
    '\u4E16\u754C\u304C\u5F85\u3063\u3066\u308B\u3088\uFF01'
  ]
};
function randomFunToast(category) {
  const msgs = funToasts[category];
  return msgs[Math.floor(Math.random() * msgs.length)];
}
function showFunToast(icon, msg) {
  const el = document.getElementById('funToast');
  document.getElementById('funIcon').textContent = icon;
  document.getElementById('funMsg').textContent = msg;
  el.classList.add('show');
  clearTimeout(funToastTimer);
  funToastTimer = setTimeout(() => el.classList.remove('show'), 2000);
}

// ═══════════════════════════════════════════════════════
// i18n — LANGUAGE TOGGLE
// ═══════════════════════════════════════════════════════
let currentLang = localStorage.getItem('niko_lang') || 'en';

const i18n = {
  en: {
    appTitle: 'Niko Tracker',
    // Quick-add buttons
    sleep: 'Sleep',
    feeding: 'Feeding',
    poo: 'Poo',
    note: 'Note',
    // Time Since Last
    lastFed: 'Last Fed',
    lastSlept: 'Last Slept',
    lastPoo: 'Last Poo',
    // Section title
    todaysLog: "Today's Log",
    // Empty state
    emptyState: 'No entries yet for this day.<br>Tap a button above to log!',
    // Modal titles
    logSleep: 'Log Sleep',
    logFeeding: 'Log Feeding',
    logPoo: 'Log Poo',
    addNote: 'Add Note',
    editSleep: 'Edit Sleep',
    editFeeding: 'Edit Feeding',
    editPoo: 'Edit Poo',
    editNote: 'Edit Note',
    // Form labels
    fellAsleep: 'Fell Asleep',
    wokeUp: 'Woke Up (optional)',
    date: 'Date',
    time: 'Time',
    volumeMl: 'Volume (ml)',
    type: 'Type',
    peeToo: 'Pee too?',
    notesOptional: 'Notes (optional)',
    noteLabel: 'Note',
    // Select options
    formula: 'Formula',
    breastMilk: 'Breast Milk',
    mixed: 'Mixed',
    yes: 'Yes',
    no: 'No',
    // Submit buttons
    startSleep: 'Start Sleep',
    logWakeUp: 'Log Wake Up',
    saveFeeding: 'Save Feeding',
    savePoo: 'Save Poo',
    saveNote: 'Save Note',
    updateSleep: 'Update Sleep',
    updateFeeding: 'Update Feeding',
    updatePoo: 'Update Poo',
    updateNote: 'Update Note',
    // Sleep banner
    sleepingSince: 'Sleeping since',
    tapToLogWakeUp: '— tap to log wake up',
    // Sync
    synced: 'Synced',
    syncing: 'Syncing...',
    syncedJustNow: 'Synced just now',
    syncFailed: 'Sync failed — tap to retry',
    saveFailed: 'Save failed — tap to retry',
    updateFailed: 'Update failed — tap to retry',
    deleteFailed: 'Delete failed — tap to retry',
    // Toasts
    savedCheck: 'Saved &#10003;',
    deleted: 'Deleted',
    updatedCheck: 'Updated &#10003;',
    saveFailedToast: 'Save failed! Will retry...',
    updateFailedToast: 'Update failed!',
    deleteConfirm: 'Delete this entry?',
    // Summary
    last24Hours: 'Last 24 Hours',
    dailySummary: 'Daily Summary',
    weeklySummary: 'Weekly Summary',
    tab24h: '24h',
    tabDaily: 'Daily',
    tabWeekly: 'Weekly',
    totalSleep: 'Total Sleep',
    totalFeedVolume: 'Total Feed Volume',
    numberOfFeedings: 'Number of Feedings',
    pooCount: 'Poo Count',
    longestSleepStretch: 'Longest Sleep Stretch',
    sinceLastFeed: 'Since Last Feed',
    sinceLastPoo: 'Since Last Poo',
    // Weekly table
    dayCol: 'Day',
    sleepCol: 'Sleep',
    feedCol: 'Feed',
    pooCol: 'Poo',
    total: 'Total',
    avgPerDay: 'Avg/day',
    // Trends
    trends14Days: 'Trends (14 Days)',
    dailySleepHours: 'Daily Sleep (hours)',
    dailyFeedVolumeMl: 'Daily Feed Volume (ml)',
    longestSleep: 'Longest Sleep',
    avgFeedGap: 'Avg Feed Gap',
    pooFrequency: 'Poo Frequency',
    dayVsNightSleep: 'Day vs Night Sleep',
    past7Days: 'past 7 days',
    betweenFeedings: 'between feedings',
    dayNightRange: '7am–7pm vs 7pm–7am',
    dayLabel: 'Day',
    nightLabel: 'Night',
    perDay: '/day',
    // Timeline entry titles
    sleepTitle: 'Sleep',
    fellAsleepTitle: 'Fell Asleep',
    stillSleeping: 'Still sleeping...',
    formulaTitle: 'Formula',
    breastMilkTitle: 'Breast Milk',
    mixedFeedTitle: 'Mixed Feed',
    pooTitle: 'Poo',
    pooPeeTitle: 'Poo + Pee',
    noteTitle: 'Note',
    volumeNotRecorded: 'Volume not recorded',
    // Time format
    ago: 'ago',
    justNow: 'just now',
    sleepingNow: 'sleeping now',
    now: 'Now',
    // Data
    exportCsv: 'Export CSV',
    noDataExport: 'No data to export.',
    // Nav buttons
    nav24h: '24h',
    navDaily: 'Daily',
    navWeekly: 'Weekly',
    navTrends: 'Trends',
    // Placeholders
    phVolume: 'e.g. 90',
    phPooNotes: 'Color, consistency...',
    phNote: 'Anything to remember...',
    // Sleep banner icon
    sleepBannerIcon: '&#x1F4A4;'
  },
  ja: {
    appTitle: 'ニコトラッカー',
    sleep: 'ねんね',
    feeding: 'ミルク',
    poo: 'うんち',
    note: 'メモ',
    lastFed: '最後のミルク',
    lastSlept: '最後のねんね',
    lastPoo: '最後のうんち',
    todaysLog: '今日の記録',
    emptyState: 'まだ記録がありません。<br>上のボタンをタップ！',
    logSleep: 'ねんね記録',
    logFeeding: 'ミルク記録',
    logPoo: 'うんち記録',
    addNote: 'メモ追加',
    editSleep: 'ねんね編集',
    editFeeding: 'ミルク編集',
    editPoo: 'うんち編集',
    editNote: 'メモ編集',
    fellAsleep: '寝た時間',
    wokeUp: '起きた時間（任意）',
    date: '日付',
    time: '時間',
    volumeMl: '量（ml）',
    type: '種類',
    peeToo: 'おしっこも？',
    notesOptional: 'メモ（任意）',
    noteLabel: 'メモ',
    formula: 'ミルク',
    breastMilk: '母乳',
    mixed: '混合',
    yes: 'はい',
    no: 'いいえ',
    startSleep: 'ねんね開始',
    logWakeUp: '起きた記録',
    saveFeeding: 'ミルク保存',
    savePoo: 'うんち保存',
    saveNote: 'メモ保存',
    updateSleep: 'ねんね更新',
    updateFeeding: 'ミルク更新',
    updatePoo: 'うんち更新',
    updateNote: 'メモ更新',
    sleepingSince: 'ねんね中',
    tapToLogWakeUp: '— タップで起床記録',
    synced: '同期済み',
    syncing: '同期中...',
    syncedJustNow: '同期完了',
    syncFailed: '同期失敗 — タップで再試行',
    saveFailed: '保存失敗 — タップで再試行',
    updateFailed: '更新失敗 — タップで再試行',
    deleteFailed: '削除失敗 — タップで再試行',
    savedCheck: '保存 &#10003;',
    deleted: '削除しました',
    updatedCheck: '更新 &#10003;',
    saveFailedToast: '保存失敗！再試行します...',
    updateFailedToast: '更新失敗！',
    deleteConfirm: 'この記録を削除しますか？',
    last24Hours: '過去24時間',
    dailySummary: '日次サマリー',
    weeklySummary: '週次サマリー',
    tab24h: '24時間',
    tabDaily: '日次',
    tabWeekly: '週次',
    totalSleep: '合計睡眠',
    totalFeedVolume: '合計ミルク量',
    numberOfFeedings: 'ミルク回数',
    pooCount: 'うんち回数',
    longestSleepStretch: '最長睡眠',
    sinceLastFeed: '最後のミルクから',
    sinceLastPoo: '最後のうんちから',
    dayCol: '日',
    sleepCol: 'ねんね',
    feedCol: 'ミルク',
    pooCol: 'うんち',
    total: '合計',
    avgPerDay: '平均/日',
    trends14Days: 'トレンド（14日間）',
    dailySleepHours: '日次睡眠（時間）',
    dailyFeedVolumeMl: '日次ミルク量（ml）',
    longestSleep: '最長睡眠',
    avgFeedGap: '平均ミルク間隔',
    pooFrequency: 'うんち頻度',
    dayVsNightSleep: '昼 vs 夜の睡眠',
    past7Days: '過去7日間',
    betweenFeedings: 'ミルクの間隔',
    dayNightRange: '7時〜19時 vs 19時〜7時',
    dayLabel: '昼',
    nightLabel: '夜',
    perDay: '/日',
    sleepTitle: 'ねんね',
    fellAsleepTitle: '寝ました',
    stillSleeping: 'まだ寝てます...',
    formulaTitle: 'ミルク',
    breastMilkTitle: '母乳',
    mixedFeedTitle: '混合',
    pooTitle: 'うんち',
    pooPeeTitle: 'うんち + おしっこ',
    noteTitle: 'メモ',
    volumeNotRecorded: '量の記録なし',
    ago: '前',
    justNow: 'たった今',
    sleepingNow: 'ねんね中',
    now: '今',
    exportCsv: 'CSVエクスポート',
    noDataExport: 'データがありません。',
    nav24h: '24時間',
    navDaily: '日次',
    navWeekly: '週次',
    navTrends: 'トレンド',
    phVolume: '例: 90',
    phPooNotes: '色、固さなど...',
    phNote: '覚えておきたいこと...',
    sleepBannerIcon: '&#x1F4A4;'
  }
};

function t(key) {
  return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('niko_lang', lang);
  document.getElementById('langEn').classList.toggle('active', lang === 'en');
  document.getElementById('langJa').classList.toggle('active', lang === 'ja');
  applyLang();
}

function applyLang() {
  const locale = currentLang === 'ja' ? 'ja-JP' : 'en-US';

  // Header
  document.getElementById('appTitle').textContent = t('appTitle');
  document.getElementById('headerDate').textContent = new Date().toLocaleDateString(locale, { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

  // Quick-add buttons
  document.getElementById('btnSleepLabel').textContent = t('sleep');
  document.getElementById('btnFeedLabel').textContent = t('feeding');
  document.getElementById('btnPooLabel').textContent = t('poo');
  document.getElementById('btnNoteLabel').textContent = t('note');

  // Time Since Last
  document.getElementById('tslFeedLabel').textContent = t('lastFed');
  document.getElementById('tslSleepLabel').textContent = t('lastSlept');
  document.getElementById('tslPooLabel').textContent = t('lastPoo');

  // Sleep banner
  updateSleepBannerText();

  // Sync text
  const syncText = document.getElementById('syncText').textContent;
  // Only update if it's one of the known sync states
  if (syncText === 'Synced' || syncText === '同期済み') document.getElementById('syncText').textContent = t('synced');

  // Section title - re-render
  renderEntries();

  // Summary tabs
  document.getElementById('tab24hLabel').textContent = t('tab24h');
  document.getElementById('tabDailyLabel').textContent = t('tabDaily');
  document.getElementById('tabWeeklyLabel').textContent = t('tabWeekly');

  // Nav buttons
  document.getElementById('navLabel24h').textContent = t('nav24h');
  document.getElementById('navLabelDaily').textContent = t('navDaily');
  document.getElementById('navLabelWeekly').textContent = t('navWeekly');
  document.getElementById('navLabelTrends').textContent = t('navTrends');

  // Export button
  document.getElementById('exportBtn').innerHTML = '&#x1F4E5; ' + t('exportCsv');

  // Form labels
  document.getElementById('labelFellAsleep').textContent = t('fellAsleep');
  document.getElementById('labelWokeUp').textContent = t('wokeUp');
  document.getElementById('labelSleepDate').textContent = t('date');
  document.getElementById('labelFeedTime').textContent = t('time');
  document.getElementById('labelFeedVolume').textContent = t('volumeMl');
  document.getElementById('labelFeedType').textContent = t('type');
  document.getElementById('labelFeedDate').textContent = t('date');
  document.getElementById('labelPooTime').textContent = t('time');
  document.getElementById('labelPeeToo').textContent = t('peeToo');
  document.getElementById('labelPooDate').textContent = t('date');
  document.getElementById('labelPooNotes').textContent = t('notesOptional');
  document.getElementById('labelNoteTime').textContent = t('time');
  document.getElementById('labelNoteDate').textContent = t('date');
  document.getElementById('labelNote').textContent = t('noteLabel');

  // Select options
  document.getElementById('optFormula').textContent = t('formula');
  document.getElementById('optBreast').textContent = t('breastMilk');
  document.getElementById('optMixed').textContent = t('mixed');
  document.getElementById('optPeeYes').textContent = t('yes');
  document.getElementById('optPeeNo').textContent = t('no');

  // Placeholders
  document.getElementById('feedVolume').placeholder = t('phVolume');
  document.getElementById('pooNotes').placeholder = t('phPooNotes');
  document.getElementById('noteText').placeholder = t('phNote');

  // Trends title
  document.getElementById('trendsTitle').innerHTML = '&#x1F4C8; ' + t('trends14Days');

  // Re-render time since last (for "ago"/"just now" strings)
  renderTimeSinceLast();
}

function updateSleepBannerText() {
  const raw = localStorage.getItem('niko_sleep_active');
  if (raw) {
    const data = JSON.parse(raw);
    const banner = document.getElementById('sleepBanner');
    banner.innerHTML = '&#x1F4A4; ' + t('sleepingSince') + ' <span id="sleepSinceTime">' + formatTime12(data.time) + '</span> ' + t('tapToLogWakeUp');
  }
}

// ═══════════════════════════════════════════════════════
// SLEEP BANNER
// ═══════════════════════════════════════════════════════
function checkSleepActive() {
  const raw = localStorage.getItem('niko_sleep_active');
  const banner = document.getElementById('sleepBanner');
  if (raw) {
    const data = JSON.parse(raw);
    banner.innerHTML = '&#x1F4A4; ' + t('sleepingSince') + ' <span id="sleepSinceTime">' + formatTime12(data.time) + '</span> ' + t('tapToLogWakeUp');
    banner.classList.add('active');
  } else {
    banner.classList.remove('active');
  }
}

async function openSleepWake() {
  const raw = localStorage.getItem('niko_sleep_active');
  if (!raw) return;
  const data = JSON.parse(raw);
  const wakeTime = nowTimeStr();
  await addEntry({
    type: 'sleep',
    date: data.date,
    sleepStart: data.time,
    sleepEnd: wakeTime,
    sleepEndDate: todayStr()
  });
  await saveSleepActive(null);
  showFunToast('\u2600\uFE0F', randomFunToast('sleepEnd'));
  checkSleepActive();
  renderEntries();
  renderTimeSinceLast();
}

// ═══════════════════════════════════════════════════════
// MODAL
// ═══════════════════════════════════════════════════════
function openModal(type) {
  const overlay = document.getElementById('modalOverlay');
  const icons = { sleep: '&#x1F4A4; ', feed: '&#x1F37C; ', poo: '&#x1F4A9; ', note: '&#x1F4DD; ' };
  const titleKeys = { sleep: 'logSleep', feed: 'logFeeding', poo: 'logPoo', note: 'addNote' };
  document.getElementById('modalTitle').innerHTML = icons[type] + t(titleKeys[type]);
  document.getElementById('entryType').value = type;

  // Clear edit state
  document.getElementById('editingId').value = '';
  document.getElementById('editingFbKey').value = '';

  document.getElementById('sleepFields').style.display = 'none';
  document.getElementById('feedFields').style.display = 'none';
  document.getElementById('pooFields').style.display = 'none';
  document.getElementById('noteFields').style.display = 'none';

  const btn = document.getElementById('submitBtn');
  btn.className = 'submit-btn ' + type + '-btn';
  btn.disabled = false;

  const today = todayStr();
  const now = nowTimeStr();

  if (type === 'sleep') {
    document.getElementById('sleepFields').style.display = 'block';
    document.getElementById('sleepStart').value = now;
    document.getElementById('sleepEnd').value = '';
    document.getElementById('sleepDate').value = today;
    const active = localStorage.getItem('niko_sleep_active');
    if (active) {
      const data = JSON.parse(active);
      document.getElementById('sleepStart').value = data.time;
      document.getElementById('sleepDate').value = data.date;
      document.getElementById('sleepEnd').value = now;
      btn.textContent = t('logWakeUp');
    } else {
      btn.textContent = t('startSleep');
    }
  } else if (type === 'feed') {
    document.getElementById('feedFields').style.display = 'block';
    document.getElementById('feedTime').value = now;
    document.getElementById('feedVolume').value = '';
    document.getElementById('feedDate').value = today;
    btn.textContent = t('saveFeeding');
  } else if (type === 'poo') {
    document.getElementById('pooFields').style.display = 'block';
    document.getElementById('pooTime').value = now;
    document.getElementById('pooDate').value = today;
    document.getElementById('pooNotes').value = '';
    btn.textContent = t('savePoo');
  } else {
    document.getElementById('noteFields').style.display = 'block';
    document.getElementById('noteTime').value = now;
    document.getElementById('noteDate').value = today;
    document.getElementById('noteText').value = '';
    btn.textContent = t('saveNote');
  }

  overlay.classList.add('active');
}

function editEntry(id) {
  const entry = entriesCache.find(e => e.id === id);
  if (!entry) return;

  const type = entry.type;
  const overlay = document.getElementById('modalOverlay');
  const icons = { sleep: '&#x1F4A4; ', feed: '&#x1F37C; ', poo: '&#x1F4A9; ', note: '&#x1F4DD; ' };
  const editKeys = { sleep: 'editSleep', feed: 'editFeeding', poo: 'editPoo', note: 'editNote' };
  document.getElementById('modalTitle').innerHTML = icons[type] + t(editKeys[type]);
  document.getElementById('entryType').value = type;

  // Set edit state
  document.getElementById('editingId').value = entry.id;
  document.getElementById('editingFbKey').value = entry._fbKey || '';

  document.getElementById('sleepFields').style.display = 'none';
  document.getElementById('feedFields').style.display = 'none';
  document.getElementById('pooFields').style.display = 'none';
  document.getElementById('noteFields').style.display = 'none';

  const btn = document.getElementById('submitBtn');
  btn.className = 'submit-btn ' + type + '-btn';
  btn.disabled = false;

  if (type === 'sleep') {
    document.getElementById('sleepFields').style.display = 'block';
    document.getElementById('sleepStart').value = entry.sleepStart || '';
    document.getElementById('sleepEnd').value = entry.sleepEnd || '';
    document.getElementById('sleepDate').value = entry.date || '';
    btn.textContent = t('updateSleep');
  } else if (type === 'feed') {
    document.getElementById('feedFields').style.display = 'block';
    document.getElementById('feedTime').value = entry.time || '';
    document.getElementById('feedVolume').value = entry.volume || '';
    document.getElementById('feedType').value = entry.feedType || 'formula';
    document.getElementById('feedDate').value = entry.date || '';
    btn.textContent = t('updateFeeding');
  } else if (type === 'poo') {
    document.getElementById('pooFields').style.display = 'block';
    document.getElementById('pooTime').value = entry.time || '';
    document.getElementById('pooPee').value = entry.pee || 'yes';
    document.getElementById('pooDate').value = entry.date || '';
    document.getElementById('pooNotes').value = entry.notes || '';
    btn.textContent = t('updatePoo');
  } else {
    document.getElementById('noteFields').style.display = 'block';
    document.getElementById('noteTime').value = entry.time || '';
    document.getElementById('noteDate').value = entry.date || '';
    document.getElementById('noteText').value = entry.text || '';
    btn.textContent = t('updateNote');
  }

  overlay.classList.add('active');
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
function closeModalBg(e) { if (e.target === document.getElementById('modalOverlay')) closeModal(); }

async function saveEntry(e) {
  e.preventDefault();
  const type = document.getElementById('entryType').value;
  const btn = document.getElementById('submitBtn');
  btn.disabled = true;

  const editingId = document.getElementById('editingId').value;
  const editingFbKey = document.getElementById('editingFbKey').value;
  const isEditing = !!editingId;

  if (type === 'sleep') {
    const start = document.getElementById('sleepStart').value;
    const end = document.getElementById('sleepEnd').value;
    const date = document.getElementById('sleepDate').value;
    if (!start) { btn.disabled = false; return; }

    if (isEditing) {
      await updateEntry(editingId, editingFbKey, { sleepStart: start, sleepEnd: end || null, sleepEndDate: end ? date : null, date });
    } else {
      const active = localStorage.getItem('niko_sleep_active');
      if (active && end) {
        await addEntry({ type: 'sleep', date, sleepStart: start, sleepEnd: end, sleepEndDate: todayStr() });
        await saveSleepActive(null);
        showFunToast('\u2600\uFE0F', randomFunToast('sleepEnd'));
      } else if (end) {
        await addEntry({ type: 'sleep', date, sleepStart: start, sleepEnd: end, sleepEndDate: date });
        showFunToast('\u2600\uFE0F', randomFunToast('sleepEnd'));
      } else {
        await saveSleepActive({ time: start, date });
        showFunToast('\uD83C\uDF19', randomFunToast('sleepStart'));
      }
    }
  } else if (type === 'feed') {
    const time = document.getElementById('feedTime').value;
    const volume = document.getElementById('feedVolume').value;
    const feedType = document.getElementById('feedType').value;
    const date = document.getElementById('feedDate').value;
    if (!time) { btn.disabled = false; return; }

    if (isEditing) {
      await updateEntry(editingId, editingFbKey, { time, volume: volume ? Number(volume) : null, feedType, date });
    } else {
      await addEntry({ type: 'feed', date, time, volume: volume ? Number(volume) : null, feedType });
      showFunToast('\uD83C\uDF7C', randomFunToast('feed'));
    }
  } else if (type === 'poo') {
    const time = document.getElementById('pooTime').value;
    const pee = document.getElementById('pooPee').value;
    const date = document.getElementById('pooDate').value;
    const notes = document.getElementById('pooNotes').value;
    if (!time) { btn.disabled = false; return; }

    if (isEditing) {
      await updateEntry(editingId, editingFbKey, { time, pee, date, notes });
    } else {
      await addEntry({ type: 'poo', date, time, pee, notes });
      showFunToast('\uD83D\uDCA9', randomFunToast('poo'));
    }
  } else {
    const time = document.getElementById('noteTime').value;
    const date = document.getElementById('noteDate').value;
    const text = document.getElementById('noteText').value;
    if (!text) { btn.disabled = false; return; }

    if (isEditing) {
      await updateEntry(editingId, editingFbKey, { time, date, text });
    } else {
      await addEntry({ type: 'note', date, time, text });
    }
  }

  closeModal();
  checkSleepActive();
  renderEntries();
  renderTimeSinceLast();
}

// ═══════════════════════════════════════════════════════
// RENDER TIMELINE
// ═══════════════════════════════════════════════════════
function renderEntries() {
  const dateStr = document.getElementById('viewDate').value;
  const entries = loadEntries().filter(e => e.date === dateStr);
  entries.sort((a, b) => {
    const tA = a.sleepStart || a.time || '00:00';
    const tB = b.sleepStart || b.time || '00:00';
    return tB.localeCompare(tA);
  });

  const el = document.getElementById('timeline');
  const sectionTitle = document.querySelector('.section-title');
  const today = todayStr();
  sectionTitle.textContent = dateStr === today ? t('todaysLog') : formatDateShort(dateStr);

  if (entries.length === 0) {
    el.innerHTML = '<div class="empty-state">' + t('emptyState') + '</div>';
    return;
  }

  el.innerHTML = entries.map(e => {
    let icon, iconClass, title, sub, timeStr;
    if (e.type === 'sleep') {
      icon = '&#x1F4A4;'; iconClass = 'sleep';
      timeStr = formatTime12(e.sleepStart);
      if (e.sleepEnd) {
        title = t('sleepTitle');
        const mins = calcSleepMins(e);
        const hrs = Math.floor(mins / 60);
        const m = mins % 60;
        sub = formatTime12(e.sleepStart) + ' &#8594; ' + formatTime12(e.sleepEnd) + ' (' + (hrs > 0 ? hrs + 'h ' : '') + m + 'm)';
      } else {
        title = t('fellAsleepTitle'); sub = t('stillSleeping');
      }
    } else if (e.type === 'feed') {
      icon = '&#x1F37C;'; iconClass = 'feed';
      timeStr = formatTime12(e.time);
      title = e.feedType === 'formula' ? t('formulaTitle') : e.feedType === 'mixed' ? t('mixedFeedTitle') : t('breastMilkTitle');
      sub = e.volume ? e.volume + ' ml' : t('volumeNotRecorded');
    } else if (e.type === 'poo') {
      icon = '&#x1F4A9;'; iconClass = 'poo';
      timeStr = formatTime12(e.time);
      title = e.pee === 'yes' ? t('pooPeeTitle') : t('pooTitle');
      sub = e.notes || '';
    } else {
      icon = '&#x1F4DD;'; iconClass = 'note';
      timeStr = formatTime12(e.time);
      title = t('noteTitle');
      sub = e.text || '';
    }
    return '<div class="entry-card" onclick="editEntry(\'' + e.id + '\')">' +
      '<div class="entry-icon ' + iconClass + '">' + icon + '</div>' +
      '<div class="entry-details">' +
        '<div class="entry-title">' + title + '</div>' +
        (sub ? '<div class="entry-sub">' + sub + '</div>' : '') +
      '</div>' +
      '<span class="entry-time">' + timeStr + '</span>' +
      '<button class="entry-delete" onclick="event.stopPropagation();confirmDelete(\'' + e.id + '\')" title="Delete">&#215;</button>' +
    '</div>';
  }).join('');
}

function confirmDelete(id) {
  if (confirm(t('deleteConfirm'))) deleteEntry(id);
}

function calcSleepMins(e) {
  if (!e.sleepStart || !e.sleepEnd) return 0;
  const [sh, sm] = e.sleepStart.split(':').map(Number);
  const [eh, em] = e.sleepEnd.split(':').map(Number);
  let startMins = sh * 60 + sm;
  let endMins = eh * 60 + em;
  if ((e.sleepEndDate && e.sleepEndDate !== e.date) || endMins < startMins) {
    endMins += 24 * 60;
  }
  return endMins - startMins;
}

// ═══════════════════════════════════════════════════════
// TIME SINCE LAST
// ═══════════════════════════════════════════════════════
function getEntryTimestamp(e) {
  // Returns a Date object for the entry's effective time
  const timeStr = e.type === 'sleep' ? (e.sleepEnd || e.sleepStart) : e.time;
  const dateStr = e.type === 'sleep' ? (e.sleepEndDate || e.date) : e.date;
  if (!timeStr || !dateStr) return null;
  return new Date(dateStr + 'T' + timeStr + ':00');
}

function formatTimeSince(diffMs) {
  if (diffMs < 0) return '--';
  const totalMins = Math.floor(diffMs / 60000);
  if (totalMins < 1) return t('justNow');
  const hrs = Math.floor(totalMins / 60);
  const mins = totalMins % 60;
  const agoStr = t('ago');
  if (currentLang === 'ja') {
    if (hrs === 0) return mins + '分' + agoStr;
    if (mins === 0) return hrs + '時間' + agoStr;
    return hrs + '時間' + mins + '分' + agoStr;
  }
  if (hrs === 0) return mins + 'm ' + agoStr;
  if (mins === 0) return hrs + 'h ' + agoStr;
  return hrs + 'h ' + mins + 'm ' + agoStr;
}

function renderTimeSinceLast() {
  const entries = loadEntries();
  const now = new Date();

  // Find most recent feed
  let lastFeedTime = null;
  let lastFeedAt = null;
  entries.filter(e => e.type === 'feed').forEach(e => {
    const ts = getEntryTimestamp(e);
    if (ts && (!lastFeedTime || ts > lastFeedTime)) {
      lastFeedTime = ts;
      lastFeedAt = formatTime12(e.time);
    }
  });

  // Find most recent sleep (use sleep end if available, else sleep start)
  let lastSleepTime = null;
  let lastSleepAt = null;
  entries.filter(e => e.type === 'sleep').forEach(e => {
    const ts = getEntryTimestamp(e);
    if (ts && (!lastSleepTime || ts > lastSleepTime)) {
      lastSleepTime = ts;
      lastSleepAt = e.sleepEnd ? formatTime12(e.sleepEnd) : formatTime12(e.sleepStart);
    }
  });

  // Check if currently sleeping
  const sleepActive = localStorage.getItem('niko_sleep_active');
  if (sleepActive) {
    const data = JSON.parse(sleepActive);
    const sleepStartTs = new Date(data.date + 'T' + data.time + ':00');
    if (!lastSleepTime || sleepStartTs > lastSleepTime) {
      lastSleepTime = sleepStartTs;
      lastSleepAt = t('sleepingNow');
    }
  }

  // Find most recent poo
  let lastPooTime = null;
  let lastPooAt = null;
  entries.filter(e => e.type === 'poo').forEach(e => {
    const ts = getEntryTimestamp(e);
    if (ts && (!lastPooTime || ts > lastPooTime)) {
      lastPooTime = ts;
      lastPooAt = formatTime12(e.time);
    }
  });

  // Update DOM
  document.getElementById('tslFeed').textContent = lastFeedTime ? formatTimeSince(now - lastFeedTime) : '--';
  document.getElementById('tslFeedSub').textContent = lastFeedAt || '';

  if (sleepActive && lastSleepAt === t('sleepingNow')) {
    document.getElementById('tslSleep').textContent = t('now');
    document.getElementById('tslSleepSub').textContent = t('sleepingNow');
  } else {
    document.getElementById('tslSleep').textContent = lastSleepTime ? formatTimeSince(now - lastSleepTime) : '--';
    document.getElementById('tslSleepSub').textContent = lastSleepAt || '';
  }

  document.getElementById('tslPoo').textContent = lastPooTime ? formatTimeSince(now - lastPooTime) : '--';
  document.getElementById('tslPooSub').textContent = lastPooAt || '';
}

// ═══════════════════════════════════════════════════════
// DATE NAV
// ═══════════════════════════════════════════════════════
function shiftDate(n) {
  const inp = document.getElementById('viewDate');
  inp.value = addDays(inp.value, n);
  renderEntries();
}

// ═══════════════════════════════════════════════════════
// SUMMARY
// ═══════════════════════════════════════════════════════
function openSummary(tab) {
  document.getElementById('summaryOverlay').classList.add('active');
  switchSummaryTab(tab);
}
function closeSummary() { document.getElementById('summaryOverlay').classList.remove('active'); }
function closeSummaryBg(e) { if (e.target === document.getElementById('summaryOverlay')) closeSummary(); }

function switchSummaryTab(tab) {
  document.getElementById('tab24h').classList.toggle('active', tab === '24h');
  document.getElementById('tabDaily').classList.toggle('active', tab === 'daily');
  document.getElementById('tabWeekly').classList.toggle('active', tab === 'weekly');

  const body = document.getElementById('summaryBody');
  const entries = loadEntries();
  const dateStr = document.getElementById('viewDate').value;

  if (tab === '24h') {
    document.getElementById('summaryTitle').textContent = t('last24Hours');
    const now = new Date();
    const cutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);

    // Filter entries within the last 24 hours
    const recentEntries = entries.filter(e => {
      const ts = getEntryTimestamp(e);
      return ts && ts >= cutoff && ts <= now;
    });

    const stats = calcDayStats(recentEntries);

    // Find longest single sleep stretch in the 24h window
    let longestSleepMins = 0;
    recentEntries.filter(e => e.type === 'sleep').forEach(e => {
      const mins = calcSleepMins(e);
      if (mins > longestSleepMins) longestSleepMins = mins;
    });

    // Time since last feed
    let lastFeedAgo = '--';
    let lastFeedTime = null;
    entries.filter(e => e.type === 'feed').forEach(e => {
      const ts = getEntryTimestamp(e);
      if (ts && (!lastFeedTime || ts > lastFeedTime)) lastFeedTime = ts;
    });
    if (lastFeedTime) lastFeedAgo = formatTimeSince(now - lastFeedTime);

    // Time since last poo
    let lastPooAgo = '--';
    let lastPooTime = null;
    entries.filter(e => e.type === 'poo').forEach(e => {
      const ts = getEntryTimestamp(e);
      if (ts && (!lastPooTime || ts > lastPooTime)) lastPooTime = ts;
    });
    if (lastPooTime) lastPooAgo = formatTimeSince(now - lastPooTime);

    let html = renderDayStats(stats);
    html += '<div class="summary-stat">' +
      '<span class="stat-label">&#x1F4A4; ' + t('longestSleepStretch') + '</span>' +
      '<span class="stat-value sleep-color">' + formatMins(longestSleepMins) + '</span>' +
    '</div>';
    html += '<div class="summary-stat">' +
      '<span class="stat-label">&#x1F37C; ' + t('sinceLastFeed') + '</span>' +
      '<span class="stat-value feed-color">' + lastFeedAgo + '</span>' +
    '</div>';
    html += '<div class="summary-stat">' +
      '<span class="stat-label">&#x1F4A9; ' + t('sinceLastPoo') + '</span>' +
      '<span class="stat-value poo-color">' + lastPooAgo + '</span>' +
    '</div>';
    body.innerHTML = html;

  } else if (tab === 'daily') {
    document.getElementById('summaryTitle').textContent = t('dailySummary') + ' \u2014 ' + formatDateShort(dateStr);
    const dayEntries = entries.filter(e => e.date === dateStr);
    const stats = calcDayStats(dayEntries);
    body.innerHTML = renderDayStats(stats);
  } else {
    const weekStart = getWeekStart(dateStr);
    document.getElementById('summaryTitle').textContent = t('weeklySummary');
    let html = '<div class="summary-day-list">';
    html += '<div class="summary-day-row header"><span>' + t('dayCol') + '</span><span>' + t('sleepCol') + '</span><span>' + t('feedCol') + '</span><span>' + t('pooCol') + '</span></div>';
    let totals = { sleepMins: 0, feedMl: 0, feedCount: 0, pooCount: 0 };
    for (let i = 0; i < 7; i++) {
      const d = addDays(weekStart, i);
      const dayEntries = entries.filter(e => e.date === d);
      const stats = calcDayStats(dayEntries);
      totals.sleepMins += stats.sleepMins;
      totals.feedMl += stats.feedMl;
      totals.feedCount += stats.feedCount;
      totals.pooCount += stats.pooCount;
      const locale = currentLang === 'ja' ? 'ja-JP' : 'en-US';
      const dayName = new Date(d + 'T00:00:00').toLocaleDateString(locale, { weekday: 'short', month: 'numeric', day: 'numeric' });
      const isToday = d === todayStr();
      html += '<div class="summary-day-row"' + (isToday ? ' style="font-weight:600"' : '') + '>' +
        '<span>' + dayName + '</span>' +
        '<span>' + formatMins(stats.sleepMins) + '</span>' +
        '<span>' + (stats.feedMl > 0 ? stats.feedMl + ' ml' : '-') + '</span>' +
        '<span>' + stats.pooCount + '</span>' +
      '</div>';
    }
    html += '<div class="summary-day-row" style="font-weight:700;border-top:2px solid var(--text)">' +
      '<span>' + t('total') + '</span>' +
      '<span>' + formatMins(totals.sleepMins) + '</span>' +
      '<span>' + (totals.feedMl > 0 ? totals.feedMl + ' ml' : '-') + '</span>' +
      '<span>' + totals.pooCount + '</span>' +
    '</div>';
    html += '<div class="summary-day-row" style="color:var(--text-light)">' +
      '<span>' + t('avgPerDay') + '</span>' +
      '<span>' + formatMins(Math.round(totals.sleepMins / 7)) + '</span>' +
      '<span>' + (totals.feedMl > 0 ? Math.round(totals.feedMl / 7) + ' ml' : '-') + '</span>' +
      '<span>' + (totals.pooCount / 7).toFixed(1) + '</span>' +
    '</div>';
    html += '</div>';
    body.innerHTML = html;
  }
}

function calcDayStats(dayEntries) {
  let sleepMins = 0, feedMl = 0, feedCount = 0, pooCount = 0;
  dayEntries.forEach(e => {
    if (e.type === 'sleep') sleepMins += calcSleepMins(e);
    if (e.type === 'feed') { feedCount++; feedMl += (e.volume || 0); }
    if (e.type === 'poo') pooCount++;
  });
  return { sleepMins, feedMl, feedCount, pooCount };
}

function formatMins(m) {
  if (m === 0) return '-';
  const h = Math.floor(m / 60);
  const mins = m % 60;
  return h + 'h ' + mins + 'm';
}

function renderDayStats(stats) {
  return '<div class="summary-stat">' +
      '<span class="stat-label">&#x1F4A4; ' + t('totalSleep') + '</span>' +
      '<span class="stat-value sleep-color">' + formatMins(stats.sleepMins) + '</span>' +
    '</div>' +
    '<div class="summary-stat">' +
      '<span class="stat-label">&#x1F37C; ' + t('totalFeedVolume') + '</span>' +
      '<span class="stat-value feed-color">' + (stats.feedMl > 0 ? stats.feedMl + ' ml' : '-') + '</span>' +
    '</div>' +
    '<div class="summary-stat">' +
      '<span class="stat-label">&#x1F37C; ' + t('numberOfFeedings') + '</span>' +
      '<span class="stat-value feed-color">' + stats.feedCount + '</span>' +
    '</div>' +
    '<div class="summary-stat">' +
      '<span class="stat-label">&#x1F4A9; ' + t('pooCount') + '</span>' +
      '<span class="stat-value poo-color">' + stats.pooCount + '</span>' +
    '</div>';
}

// ═══════════════════════════════════════════════════════
// TRENDS
// ═══════════════════════════════════════════════════════
function openTrends() {
  document.getElementById('trendsOverlay').classList.add('active');
  renderTrends();
}
function closeTrends() { document.getElementById('trendsOverlay').classList.remove('active'); }
function closeTrendsBg(e) { if (e.target === document.getElementById('trendsOverlay')) closeTrends(); }

function renderTrends() {
  const entries = loadEntries();
  const today = todayStr();
  const days = [];

  // Build 14 days of data (today and 13 days before)
  for (let i = 13; i >= 0; i--) {
    const d = addDays(today, -i);
    const dayEntries = entries.filter(e => e.date === d);
    const stats = calcDayStats(dayEntries);
    const dt = new Date(d + 'T00:00:00');
    const trendLocale = currentLang === 'ja' ? 'ja-JP' : 'en-US';
    const dayLabel = dt.toLocaleDateString(trendLocale, { weekday: 'narrow' });
    const dayNum = dt.getDate();
    days.push({
      date: d,
      label: dayLabel,
      dayNum: dayNum,
      sleepHrs: Math.round((stats.sleepMins / 60) * 10) / 10,
      feedMl: stats.feedMl
    });
  }

  // Find max values for scaling
  const maxSleep = Math.max(...days.map(d => d.sleepHrs), 1);
  const maxFeed = Math.max(...days.map(d => d.feedMl), 1);

  let html = '';

  // Sleep chart
  html += '<div class="chart-section">';
  html += '<div class="chart-title">&#x1F4A4; ' + t('dailySleepHours') + '</div>';
  html += '<div class="chart-container">';
  html += '<div class="chart-y-label">' + maxSleep.toFixed(1) + 'h</div>';
  html += '<div class="chart-area">';
  days.forEach(d => {
    const pct = maxSleep > 0 ? (d.sleepHrs / maxSleep) * 100 : 0;
    const valLabel = d.sleepHrs > 0 ? d.sleepHrs.toFixed(1) : '';
    html += '<div class="chart-bar-wrap">' +
      (valLabel ? '<div class="chart-bar-val">' + valLabel + '</div>' : '<div class="chart-bar-val">&nbsp;</div>') +
      '<div class="chart-bar sleep-bar" style="height:' + pct + '%"></div>' +
    '</div>';
  });
  html += '</div>';
  html += '<div class="chart-x-labels">';
  days.forEach(d => {
    html += '<div class="chart-x-label">' + d.dayNum + '</div>';
  });
  html += '</div>';
  html += '</div></div>';

  // Feed chart
  html += '<div class="chart-section">';
  html += '<div class="chart-title">&#x1F37C; ' + t('dailyFeedVolumeMl') + '</div>';
  html += '<div class="chart-container">';
  html += '<div class="chart-y-label">' + maxFeed + ' ml</div>';
  html += '<div class="chart-area">';
  days.forEach(d => {
    const pct = maxFeed > 0 ? (d.feedMl / maxFeed) * 100 : 0;
    const valLabel = d.feedMl > 0 ? d.feedMl : '';
    html += '<div class="chart-bar-wrap">' +
      (valLabel ? '<div class="chart-bar-val">' + valLabel + '</div>' : '<div class="chart-bar-val">&nbsp;</div>') +
      '<div class="chart-bar feed-bar" style="height:' + pct + '%"></div>' +
    '</div>';
  });
  html += '</div>';
  html += '<div class="chart-x-labels">';
  days.forEach(d => {
    html += '<div class="chart-x-label">' + d.dayNum + '</div>';
  });
  html += '</div>';
  html += '</div></div>';

  // Key stats (past 7 days)
  html += renderTrendStats(entries, today);

  document.getElementById('trendsBody').innerHTML = html;
}

function renderTrendStats(entries, today) {
  // Collect entries for the past 7 days
  const past7Dates = [];
  for (let i = 6; i >= 0; i--) {
    past7Dates.push(addDays(today, -i));
  }
  const past7Entries = entries.filter(e => past7Dates.includes(e.date));

  // 1. Longest sleep stretch in past 7 days
  let longestSleepMins = 0;
  past7Entries.filter(e => e.type === 'sleep').forEach(e => {
    const mins = calcSleepMins(e);
    if (mins > longestSleepMins) longestSleepMins = mins;
  });

  // 2. Average time between feedings (past 7 days)
  const feedTimestamps = [];
  past7Entries.filter(e => e.type === 'feed').forEach(e => {
    const ts = getEntryTimestamp(e);
    if (ts) feedTimestamps.push(ts.getTime());
  });
  feedTimestamps.sort((a, b) => a - b);
  let avgFeedGapMins = 0;
  if (feedTimestamps.length > 1) {
    let totalGap = 0;
    for (let i = 1; i < feedTimestamps.length; i++) {
      totalGap += feedTimestamps[i] - feedTimestamps[i - 1];
    }
    avgFeedGapMins = Math.round((totalGap / (feedTimestamps.length - 1)) / 60000);
  }

  // 3. Day vs night sleep split (past 7 days)
  // Daytime: 7am-7pm, Nighttime: 7pm-7am
  let dayMins = 0;
  let nightMins = 0;
  past7Entries.filter(e => e.type === 'sleep' && e.sleepStart && e.sleepEnd).forEach(e => {
    const [sh, sm] = e.sleepStart.split(':').map(Number);
    const startMinOfDay = sh * 60 + sm;
    const totalMins = calcSleepMins(e);

    // Walk through each minute of sleep and classify it
    for (let m = 0; m < totalMins; m++) {
      const minuteOfDay = (startMinOfDay + m) % (24 * 60);
      // Day = 7:00 (420) to 18:59 (1139), Night = 19:00 (1140) to 6:59 (419)
      if (minuteOfDay >= 420 && minuteOfDay < 1140) {
        dayMins++;
      } else {
        nightMins++;
      }
    }
  });
  const totalSleepMinsDN = dayMins + nightMins;
  const dayPct = totalSleepMinsDN > 0 ? Math.round((dayMins / totalSleepMinsDN) * 100) : 0;
  const nightPct = totalSleepMinsDN > 0 ? 100 - dayPct : 0;

  // 4. Average poo frequency (past 7 days)
  const pooCount7 = past7Entries.filter(e => e.type === 'poo').length;
  const avgPooPerDay = (pooCount7 / 7).toFixed(1);

  let html = '<div class="trend-stats">';

  // Longest sleep
  html += '<div class="trend-stat-card">' +
    '<div class="ts-label">&#x1F4A4; ' + t('longestSleep') + '</div>' +
    '<div class="ts-value">' + formatMins(longestSleepMins) + '</div>' +
    '<div class="ts-sub">' + t('past7Days') + '</div>' +
  '</div>';

  // Avg feed gap
  html += '<div class="trend-stat-card">' +
    '<div class="ts-label">&#x1F37C; ' + t('avgFeedGap') + '</div>' +
    '<div class="ts-value">' + (avgFeedGapMins > 0 ? formatMins(avgFeedGapMins) : '--') + '</div>' +
    '<div class="ts-sub">' + t('betweenFeedings') + '</div>' +
  '</div>';

  // Poo frequency
  html += '<div class="trend-stat-card">' +
    '<div class="ts-label">&#x1F4A9; ' + t('pooFrequency') + '</div>' +
    '<div class="ts-value">' + avgPooPerDay + t('perDay') + '</div>' +
    '<div class="ts-sub">' + t('past7Days') + '</div>' +
  '</div>';

  // Day vs night sleep (takes full width)
  html += '<div class="trend-stat-card">' +
    '<div class="ts-label">&#x1F319; ' + t('dayVsNightSleep') + '</div>' +
    '<div class="day-night-bar-wrap">' +
      '<div class="day-night-bar">' +
        '<div class="day-portion" style="width:' + dayPct + '%"></div>' +
        '<div class="night-portion" style="width:' + nightPct + '%"></div>' +
      '</div>' +
      '<div class="day-night-labels">' +
        '<span>' + t('dayLabel') + ' ' + dayPct + '%</span>' +
        '<span>' + t('nightLabel') + ' ' + nightPct + '%</span>' +
      '</div>' +
    '</div>' +
    '<div class="ts-sub">' + t('dayNightRange') + '</div>' +
  '</div>';

  html += '</div>';
  return html;
}

// ═══════════════════════════════════════════════════════
// EXPORT CSV
// ═══════════════════════════════════════════════════════
function exportData() {
  const entries = loadEntries();
  if (entries.length === 0) { alert(t('noDataExport')); return; }
  const headers = ['id','type','date','time','sleepStart','sleepEnd','sleepEndDate','volume','feedType','pee','notes','text','createdAt'];
  let csv = headers.join(',') + '\n';
  entries.forEach(e => {
    csv += headers.map(h => {
      const v = e[h];
      if (v == null) return '';
      return '"' + String(v).replace(/"/g, '""') + '"';
    }).join(',') + '\n';
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'niko-tracker-' + todayStr() + '.csv';
  a.click();
}

// ═══════════════════════════════════════════════════════
// AUTO-REFRESH — keep data in sync between parents
// ═══════════════════════════════════════════════════════
// Refresh every 30 seconds when page is visible
let refreshInterval;
function startAutoRefresh() {
  refreshInterval = setInterval(() => {
    if (!document.hidden) syncFromCloud();
  }, 30000);
}
// Also refresh when page becomes visible (e.g. switching back to tab)
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) syncFromCloud();
});

// Update "time since last" every 60 seconds
let timeSinceInterval;
function startTimeSinceRefresh() {
  timeSinceInterval = setInterval(() => {
    if (!document.hidden) renderTimeSinceLast();
  }, 60000);
}

// ═══════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════
document.getElementById('viewDate').value = todayStr();
// Apply saved language on load
setLang(currentLang);
syncFromCloud();
startAutoRefresh();
startTimeSinceRefresh();
checkSleepActive();
renderTimeSinceLast();
</script>
</body>
</html>
